document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("registroForm");
    const mensajeDiv = document.getElementById("mensaje");

    form.addEventListener("submit", (e) => {
    e.preventDefault();
    mensajeDiv.innerHTML = "";
    mensajeDiv.className = "mensaje";

    const nombre = document.getElementById("nombre").value.trim();
    const apellido = document.getElementById("apellido").value.trim();
    const correo = document.getElementById("correo").value.trim();
    const fechaNacimiento = document.getElementById("fechaNacimiento").value;
    const codigoPromo = document.getElementById("codigoPromo").value.trim();
    const password = document.getElementById("password").value.trim();

    let errores = [];
    let beneficios = [];

    if (!nombre || !apellido || !correo || !fechaNacimiento || !password) {
        errores.push("Todos los campos obligatorios deben estar completos.");
    }

    const regexCorreo = /^[a-zA-Z0-9._%+-]+@(duoc\.cl|profesor\.duoc\.cl|gmail\.com)$/;
    if (!regexCorreo.test(correo)) {
        errores.push("El correo debe ser @duoc.cl, @profesor.duoc.cl o @gmail.com");
    }

    if (password.length < 4 || password.length > 10) {
        errores.push("La contrase√±a debe tener entre 4 y 10 caracteres.");
    }

    let edad = null;
    if (fechaNacimiento) {
        const hoy = new Date();
        const nacimiento = new Date(fechaNacimiento);
        edad = hoy.getFullYear() - nacimiento.getFullYear();
        const m = hoy.getMonth() - nacimiento.getMonth();
        if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
        }
    }

    if (edad !== null && edad >= 50) {
        beneficios.push("üéâ 50% de descuento en todos los productos por ser mayor de 50 a√±os.");
    }

    // ‚úÖ C√≥digo promocional
    if (codigoPromo.toUpperCase() === "FELICES50") {
        beneficios.push("üéâ 10% de descuento de por vida por usar el c√≥digo FELICES50.");
    }

    // ‚úÖ Correo institucional Duoc
    if (correo.endsWith("@duoc.cl")) {
        beneficios.push("üéÇ Recibir√°s una torta gratis en tu cumplea√±os (correo Duoc).");
    }

    // ‚úÖ Mostrar errores si hay
    if (errores.length > 0) {
        mensajeDiv.classList.add("error");
        mensajeDiv.innerHTML = `<p>${errores.join("<br>")}</p>`;
        return;
    }

    // ‚úÖ Guardar usuario en localStorage
    let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];

    // Verificar si ya existe el correo
    if (usuarios.some(u => u.correo === correo)) {
        mensajeDiv.classList.add("error");
        mensajeDiv.innerHTML = `<p>‚ùå Este correo ya est√° registrado.</p>`;
        return;
    }

    // Agregar nuevo usuario
    usuarios.push({ nombre, apellido, correo, password, fechaNacimiento, beneficios });
    localStorage.setItem("usuarios", JSON.stringify(usuarios));

    mensajeDiv.classList.add("exito");
    mensajeDiv.innerHTML = `
        <p>‚úÖ Registro exitoso</p>
        <ul>
        ${beneficios.map(b => `<li>${b}</li>`).join("")}
        </ul>
        <p>Puedes <a href="login.html">iniciar sesi√≥n aqu√≠</a>.</p>
    `;
    form.reset();
    });
});
